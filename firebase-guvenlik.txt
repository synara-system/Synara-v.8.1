rules_version = '2';

service cloud.firestore {
match /databases/{database}/documents {

// --- TEMEL YETKİLENDİRME FONKSİYONLARI ---
function isAuthenticated() {
  return request.auth != null;
}

// YETKİ TEK KAYNAK KURALI GÜNCELLEMESİ:
// isAdmin fonksiyonu artık Firestore okuması yapmak yerine
// doğrudan Firebase Auth token'ı içindeki "admin" claim'ini kontrol eder.
// Bu, daha performanslı ve güvenlidir.
function isAdmin() {
  return isAuthenticated() && request.auth.token.admin == true;
}

// --- KULLANICIYA ÖZEL VERİ (KASA, SOHBET) ---
match /kasa/{userId}/{document=**} {
  allow read, write: if isAuthenticated() && request.auth.uid == userId;
}

// --- KULLANICI PROFİLLERİ ---
match /users/{userId} {
  allow read: if isAuthenticated();
  allow write: if isAuthenticated() && request.auth.uid == userId;
}

// --- BLOG & YORUMLAR ---
match /blogPosts/{postId} {
  // HERKES OKUYABİLİR
  allow read: if true;

  // SADECE ADMIN YAZABİLİR, GÜNCELLEYEBİLİR, SİLEBİLİR
  allow create, update, delete: if isAdmin();

  // YORUMLAR ALT KOLEKSİYONU
  match /comments/{commentId} {
    // HERKES YORUMLARI OKUYABİLİR
    allow read: if true;
    
    // SADECE GİRİŞ YAPMIŞ KULLANICILAR YORUM EKLEYEBİLİR
    allow create: if isAuthenticated() && request.resource.data.authorId == request.auth.uid;
    
    // SADECE YORUM SAHİBİ VEYA ADMIN SİLEBİLİR
    allow delete: if isAuthenticated() && (resource.data.authorId == request.auth.uid || isAdmin());
  }
}

// --- ANALİZ PORTALI KURALLARI ---
match /analyses/{analysisId} {
  // GİRİŞ YAPMIŞ HERKES OKUYABİLİR
  allow read: if isAuthenticated();
  
  // SADECE YAZAR VEYA ADMİN GÜNCELLEYEBİLİR/SİLEBİLİR
  allow update, delete: if isAuthenticated() && (resource.data.authorId == request.auth.uid || isAdmin());
  
  // SADECE GİRİŞ YAPMIŞ KULLANICILAR YENİ ANALİZ OLUŞTURABİLİR
  allow create: if isAuthenticated() && request.resource.data.authorId == request.auth.uid;

  // OYLAMALAR ALT KOLEKSİYONU
  match /ratings/{userId} {
    // GİRİŞ YAPAN KULLANICI, SADECE KENDİ OYUNU YAZABİLİR
    allow write: if isAuthenticated() && userId == request.auth.uid;
  }

  // YORUMLAR ALT KOLEKSİYONU
  match /comments/{commentId} {
    allow read: if true;
    allow create: if isAuthenticated() && request.resource.data.authorId == request.auth.uid;
    allow delete: if isAuthenticated() && (resource.data.authorId == request.auth.uid || isAdmin());
  }
}


}
}